---
import TestimonialCard from './TestimonialCard.astro';
import testimonialsData from '../data/testimonials.json';
---

<div class="testimonials-carousel-wrapper">
  <div class="testimonials-carousel" id="testimonials-carousel">
    <div class="carousel-track">
      {testimonialsData.map((testimonial) => (
        <div class="carousel-slide">
          <TestimonialCard
            clientName={testimonial.clientName}
            companyName={testimonial.companyName}
            feedback={testimonial.feedback}
            rating={testimonial.rating}
          />
        </div>
      ))}
    </div>
  </div>
  <div class="carousel-dots" id="carousel-dots" aria-label="Testimonial navigation"></div>
</div>

<script>
  const initCarousel = () => {
    const carousel = document.getElementById('testimonials-carousel');
    const track = carousel?.querySelector('.carousel-track');
    const dotsContainer = document.getElementById('carousel-dots');
    
    if (!carousel || !track || !dotsContainer) return;

    const slides = Array.from(track.children);
    const totalSlides = slides.length;
    let currentIndex = 0;
    let autoplayInterval = null;
    let isPaused = false;

    // Create dots
    slides.forEach((_, index) => {
      const dot = document.createElement('button');
      dot.className = `carousel-dot ${index === 0 ? 'active' : ''}`;
      dot.setAttribute('aria-label', `Go to testimonial ${index + 1}`);
      dot.addEventListener('click', () => goToSlide(index));
      dotsContainer.appendChild(dot);
    });

    const dots = Array.from(dotsContainer.children);

    const updateCarousel = () => {
      const offset = -currentIndex * 100;
      track.style.transform = `translateX(${offset}%)`;
      
      // Update dots
      dots.forEach((dot, index) => {
        dot.classList.toggle('active', index === currentIndex);
      });
    };

    const goToSlide = (index) => {
      currentIndex = index;
      updateCarousel();
      resetAutoplay();
    };

    const nextSlide = () => {
      currentIndex = (currentIndex + 1) % totalSlides;
      updateCarousel();
    };

    const prevSlide = () => {
      currentIndex = (currentIndex - 1 + totalSlides) % totalSlides;
      updateCarousel();
    };

    const startAutoplay = () => {
      if (autoplayInterval) return;
      autoplayInterval = window.setInterval(() => {
        if (!isPaused) {
          nextSlide();
        }
      }, 5000); // Change slide every 5 seconds
    };

    const stopAutoplay = () => {
      if (autoplayInterval) {
        clearInterval(autoplayInterval);
        autoplayInterval = null;
      }
    };

    const resetAutoplay = () => {
      stopAutoplay();
      if (!isPaused) {
        startAutoplay();
      }
    };

    // Pause on hover
    carousel.addEventListener('mouseenter', () => {
      isPaused = true;
      stopAutoplay();
    });

    carousel.addEventListener('mouseleave', () => {
      isPaused = false;
      startAutoplay();
    });

    // Touch/swipe support
    let touchStartX = 0;
    let touchEndX = 0;

    carousel.addEventListener('touchstart', (e) => {
      touchStartX = e.touches[0].clientX;
    });

    carousel.addEventListener('touchend', (e) => {
      touchEndX = e.changedTouches[0].clientX;
      handleSwipe();
    });

    const handleSwipe = () => {
      const swipeThreshold = 50;
      const diff = touchStartX - touchEndX;

      if (Math.abs(diff) > swipeThreshold) {
        if (diff > 0) {
          nextSlide();
        } else {
          prevSlide();
        }
        resetAutoplay();
      }
    };

    // Keyboard navigation
    carousel.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft') {
        prevSlide();
        resetAutoplay();
      } else if (e.key === 'ArrowRight') {
        nextSlide();
        resetAutoplay();
      }
    });

    // Start autoplay
    startAutoplay();

    // Cleanup
    return () => {
      stopAutoplay();
    };
  };

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCarousel);
  } else {
    initCarousel();
  }
</script>

<style>
  .testimonials-carousel-wrapper {
    position: relative;
    width: 100%;
  }

  .testimonials-carousel {
    position: relative;
    width: 100%;
    overflow: hidden;
    border-radius: 24px;
  }

  .carousel-track {
    display: flex;
    transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    will-change: transform;
  }

  .carousel-slide {
    min-width: 100%;
    flex-shrink: 0;
    padding: 0 var(--spacing-sm);
    box-sizing: border-box;
  }

  .carousel-dots {
    display: flex;
    justify-content: center;
    gap: var(--spacing-xs);
    margin-top: var(--spacing-xl);
    flex-wrap: wrap;
  }

  .carousel-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid var(--color-primary);
    background: transparent;
    cursor: pointer;
    transition: all 0.3s ease;
    padding: 0;
    flex-shrink: 0;
  }

  .carousel-dot:hover {
    background: rgba(130, 232, 200, 0.3);
    transform: scale(1.2);
  }

  .carousel-dot.active {
    background: var(--color-primary);
    width: 32px;
    border-radius: 6px;
  }

  .carousel-dot:focus {
    outline: 2px solid var(--color-accent);
    outline-offset: 2px;
  }

  @media (max-width: 767px) {
    .carousel-slide {
      padding: 0;
    }

    .carousel-dots {
      margin-top: var(--spacing-lg);
    }
  }

  /* Reduced motion support */
  @media (prefers-reduced-motion: reduce) {
    .carousel-track {
      transition: none;
    }
  }
</style>

